{% extends "habits/base.html" %}
{% load dict_extras %}

{% block title %}Dashboard{% endblock %}

{% block content %}

{% load timefmt %}

<div class="container mt-4">

    <!-- ======================================================
         Welcome section
         ====================================================== -->
    <div class="card shadow-sm border-0 rounded-4 mb-4">
        <div class="card-body">
            <h4 class="fw-semibold mb-2">
                Hello and welcome üëã
            </h4>
            <p class="text-muted mb-0">
                This is a lightweight lifestyle and productivity platform built by
                <strong>Iri</strong>, <strong>Janosch</strong>, and <strong>Dave</strong>.
                <br>
                Track your habits, build consistency, and focus on what truly matters ‚Äì
                one day at a time.
            </p>
        </div>
    </div>

    <!-- ======================================================
     Pomodoro timer
     ====================================================== -->
<div class="card shadow-sm border-0 rounded-4 mb-4">
  <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-start gap-3">

    <div>
      <h5 class="fw-semibold mb-1">‚è±Ô∏è Pomodoro</h5>
      <p class="text-muted mb-0">
        Start a focus sprint ‚Äî then come back and tick off habits.
      </p>
    </div>

    <div class="d-flex flex-wrap gap-2 align-items-center">
      <span class="badge text-bg-light border" id="pomodoro-status">
        {% if active_pomodoro %}Running{% else %}Ready{% endif %}
      </span>

     <span
       class="badge text-bg-light border fs-6"
       id="pomodoro-time"
       data-seconds="{% if active_pomodoro %}
                        {{ active_pomodoro.remaining_seconds }}
                      {% else %}
                        1500
                      {% endif %}"
 >
       {% if active_pomodoro %}
         {{ active_pomodoro.remaining_seconds|mmss }}
       {% else %}
         {{ 1500|mmss }}
       {% endif %}
    </span>


      <button class="btn btn-primary rounded-pill" type="button" id="pomodoro-start">
        ‚ñ∂Ô∏è Start 25
      </button>
      <button class="btn btn-outline-secondary rounded-pill" type="button" id="pomodoro-reset">
        üîÑ Reset
      </button>
    </div>

  </div>
</div>

    <!-- ======================================================
         Page header
         ====================================================== -->
    <div class="mb-3">
        <h1 class="fw-bold mb-1">My Habits</h1>
        <p class="text-muted mb-0">
            {{ weekday }}, {{ today|date:"d M Y" }}
        </p>
    </div>

    <!-- ======================================================
         Add new habit
         ====================================================== -->
    <div class="card shadow-sm border-0 rounded-4 mb-4">
        <div class="card-body">
            <form method="post" action="{% url 'add_habit' %}" class="d-flex gap-2">
                {% csrf_token %}
                <input
                    type="text"
                    name="name"
                    class="form-control"
                    placeholder="Add a new habit..."
                    required
                >
                <button class="btn btn-primary rounded-pill">
                    Add
                </button>
            </form>
        </div>
    </div>

    <!-- ======================================================
         Two-column layout: Open / Completed
         ====================================================== -->
    <div class="row g-4">

        <!-- OPEN HABITS -->
        <div class="col-md-6">
            <h5 class="text-muted mb-3">Open</h5>

            {% for habit in habits %}
                {% if habit.id not in completed_today %}
                <div class="card shadow-sm border-0 rounded-4 mb-3">
                    <div class="card-body d-flex justify-content-between align-items-center">

                        <div>
                            <div class="fw-semibold">{{ habit.name }}</div>
                            <div class="small text-muted">Not completed today</div>

                            {% if habit.streak %}
                                <div class="small text-warning mt-1">
                                    üî• {{ habit.streak.count }} day streak
                                </div>
                            {% endif %}
                        </div>

                        <div class="d-flex gap-2 align-items-center">

                            <!-- Toggle -->
                            <form method="post" action="{% url 'toggle_habit' habit.id %}">
                                {% csrf_token %}
                                <button class="btn btn-outline-success rounded-pill">
                                    Mark done
                                </button>
                            </form>

                            <!-- Delete -->
                            <form 
                                 method="post" 
                                 action="{% url 'delete_habit' habit.id %}"
                                 onsubmit="return confirm('Are you sure you want to delete this habit?\nThis will permanently remove your streaks.')"
                            >
                            
                                {% csrf_token %}
                                <button
                                    class="btn btn-outline-danger rounded-pill"
                                    title="Delete habit"
                                >
                                    üóëÔ∏è
                                </button>
                            </form>

                        </div>
                    </div>
                </div>
                {% endif %}
            {% empty %}
                <div class="text-muted">No habits yet.</div>
            {% endfor %}
        </div>

        <!-- COMPLETED HABITS -->
        <div class="col-md-6">
            <h5 class="text-muted mb-3">Completed</h5>

            {% for habit in habits %}
                {% if habit.id in completed_today %}
                <div class="card shadow-sm bg-success-subtle border-success-subtle rounded-4 mb-3">
                    <div class="card-body d-flex justify-content-between align-items-center">

                        <div>
                            <div class="fw-semibold">{{ habit.name }}</div>
                            <div class="small text-muted">Completed today</div>

                            {% if habit.streak %}
                                <div class="small text-success mt-1">
                                    üèÜ Best: {{ habit.streak.longest_streak }} days
                                </div>
                            {% endif %}
                        </div>

                        <div class="d-flex gap-2 align-items-center">

                            <!-- Toggle -->
                            <form method="post" action="{% url 'toggle_habit' habit.id %}">
                                {% csrf_token %}
                                <button class="btn btn-success rounded-pill">
                                    ‚úî Done
                                </button>
                            </form>

                            <!-- Delete -->
                           <form 
                                 method="post" 
                                 action="{% url 'delete_habit' habit.id %}"
                                 onsubmit="return confirm('Are you sure you want to delete this habit?\nThis will permanently remove your streaks.')"
                            >
                            
                                {% csrf_token %}
                                <button
                                    class="btn btn-outline-danger rounded-pill"
                                    title="Delete habit"
                                >
                                    üóëÔ∏è
                                </button>
                            </form>

                        </div>
                    </div>
                </div>
                {% endif %}
            {% empty %}
                <div class="text-muted">Nothing completed yet.</div>
            {% endfor %}
        </div>

    </div>

    <!-- ========================================================= -->
<!-- üìö Your Reading -->
<!-- ========================================================= -->

<div class="d-flex justify-content-between align-items-start">
  <div>
    <h5 class="fw-semibold mb-1">üìö Your Reading</h5>
    <p class="text-muted small mb-0">Keep track of your saved books and progress.</p>
  </div>
  <a class="btn btn-outline-primary rounded-pill" href="{% url 'books_library' %}">Open Library</a>
</div>

<hr class="my-3">

{% if user_books %}
  <div class="d-grid gap-2">
    {% for ub in user_books %}
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="fw-semibold">{{ ub.book.title }}</div>
          <div class="small text-muted">{{ ub.progress }}% ‚Ä¢ {% if ub.status == "want" %}üìå Want{% elif ub.status == "reading" %}üìñ Reading{% else %}‚úÖ Done{% endif %}</div>
        </div>
        <a class="btn btn-sm btn-outline-secondary rounded-pill" href="{% url 'update_userbook' ub.book.id %}">Edit</a>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="text-muted">No books added yet.</div>
  <div class="mt-2">
    <a class="btn btn-sm btn-primary rounded-pill" href="{% url 'books' %}">Get a recommendation ‚ú®</a>
  </div>
{% endif %}


    <!-- ======================================================
         Weekly habit overview (UX-optimized matrix)
         ====================================================== -->
    <div class="card shadow-sm border-0 rounded-4 mt-5">
        <div class="card-body">

            <h5 class="fw-semibold mb-1">
                Weekly Overview
            </h5>

            <p class="text-muted small mb-4">
                Track your habit consistency over the last 7 days.
                Each circle represents one completed day.
            </p>

            <div class="table-responsive">
                <table class="table table-borderless table-sm align-middle text-center mb-0">

                    <thead>
                        <tr class="text-muted small">
                            <th class="text-start">Habit</th>

                            {% for day in week_days %}
                                <th>
                                    <div class="fw-semibold">{{ day|date:"D" }}</div>
                                    <div class="text-muted small">{{ day|date:"d.m" }}</div>
                                </th>
                            {% endfor %}
                        </tr>
                    </thead>

                    <tbody>
                        {% for habit in habits %}
                        <tr class="border-top">

                            <td class="text-start fw-semibold py-3">
                                {{ habit.name }}
                            </td>

                            {% for day in week_days %}
                                {% get_weekly_status weekly_checkin_map habit.id day as status %}

                                {% if day == today %}
                                    <td class="bg-light rounded">
                                {% else %}
                                    <td>
                                {% endif %}

                                    <input
                                        type="checkbox"
                                        class="form-check-input rounded-circle"
                                        {% if status %}checked{% endif %}
                                        disabled
                                    >

                                </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>

                </table>
            </div>

            <p class="text-muted small mt-4 mb-0">
                Focus on consistency, not perfection.
            </p>

        </div>
    </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  const startBtn = document.getElementById("pomodoro-start");
  const resetBtn = document.getElementById("pomodoro-reset");
  const timeEl = document.getElementById("pomodoro-time");
  const statusEl = document.getElementById("pomodoro-status");

  // üîé If any element is missing, print a helpful message and stop
  if (!startBtn || !resetBtn || !timeEl || !statusEl) {
    console.warn("Pomodoro elements not found:", { startBtn, resetBtn, timeEl, statusEl });
    return;
  }

  let timer = null;

  function render(seconds) {
    seconds = Math.max(0, seconds);
    const m = String(Math.floor(seconds / 60)).padStart(2, "0");
    const s = String(seconds % 60).padStart(2, "0");
    timeEl.textContent = `${m}:${s}`;
    timeEl.dataset.seconds = seconds;
  }

  function startCountdown() {
    if (timer) clearInterval(timer);
    timer = setInterval(() => {
      let secs = parseInt(timeEl.dataset.seconds || "0", 10);
      secs -= 1;
      render(secs);
      if (secs <= 0) {
        clearInterval(timer);
        timer = null;
        statusEl.textContent = "Finished ‚úÖ";
      }
    }, 1000);
  }

  // initial render from server (reads your data-seconds attribute)
  render(parseInt(timeEl.dataset.seconds || "1500", 10));

  startBtn.addEventListener("click", async () => {
    try {
      const res = await fetch("{% url 'pomodoro_start' %}", {
        method: "POST",
        headers: { "X-CSRFToken": getCookie("csrftoken") },
      });

      if (!res.ok) {
        const txt = await res.text();
        console.error("Start failed:", res.status, txt);
        return;
      }

      const data = await res.json();
      statusEl.textContent = "Running";
      render(data.seconds);
      startCountdown();
    } catch (err) {
      console.error("Start error:", err);
    }
  });

  resetBtn.addEventListener("click", async () => {
    try {
      const res = await fetch("{% url 'pomodoro_reset' %}", {
        method: "POST",
        headers: { "X-CSRFToken": getCookie("csrftoken") },
      });

      if (!res.ok) {
        const txt = await res.text();
        console.error("Reset failed:", res.status, txt);
        return;
      }

      const data = await res.json();
      statusEl.textContent = "Ready";
      render(data.seconds);
      if (timer) clearInterval(timer);
      timer = null;
    } catch (err) {
      console.error("Reset error:", err);
    }
  });
});
</script>


{% endblock %}